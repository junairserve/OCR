<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title><?= appTitle ?></title>
<style>
:root{--card:#121a26;--muted:#93a4b8;--text:#eaf2ff;--border:#223047;--ok:#7CFF8B;--bad:#ff6b6b;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP","Yu Gothic";background:linear-gradient(180deg,#0b0f16,#0a1220);color:var(--text)}
header{position:sticky;top:0;background:rgba(11,15,22,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:14px 12px}
h1{margin:0;font-size:18px}.sub{margin:4px 0 0;color:var(--muted);font-size:12px}
main{max-width:820px;margin:0 auto;padding:12px}
.card{background:rgba(18,26,38,.92);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0}
h2{margin:0 0 10px;font-size:15px}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);font-size:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{border:1px solid var(--border);background:#0f1622;color:var(--text);padding:12px 14px;border-radius:14px;font-size:15px;cursor:pointer}
button.primary{background:linear-gradient(180deg,#1a3048,#102338);border-color:#2a4568}
button:disabled{opacity:.45;cursor:not-allowed}
.status{margin-top:10px;font-size:13px;color:var(--muted)}.status.ok{color:var(--ok)}.status.bad{color:var(--bad)}
.tiny{font-size:11px;color:var(--muted)}a{color:#4dd4ff;text-decoration:none}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
</style>
</head><body>
<header><h1>SNç´ã¥ã‘ï¼ˆé¸æŠå¼ï¼‰</h1><p class="sub">æœ¬ä½“ã¯ã€Œåœ¨åº«ã®ã¿ã€ã€åŸºæ¿ã¯ã€Œæœªä½¿ç”¨ã®ã¿ã€è¡¨ç¤ºã—ã¾ã™</p></header>
<main>
<section class="card">
  <div class="row" style="justify-content:space-between">
    <h2>æœ¬ä½“SN</h2><span class="pill">åœ¨åº«</span>
  </div>
  <label>æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰</label>
  <input id="qBody" inputmode="numeric" placeholder="ä¾‹ï¼š0000"/>
  <label>é¸æŠ</label>
  <select id="selBody"></select>
  <div class="tiny">â€» BODY_MASTER ã® status=åœ¨åº« ã®ã¿</div>
</section>

<section class="card">
  <div class="row" style="justify-content:space-between">
    <h2>åŸºæ¿SN</h2><span class="pill">æœªä½¿ç”¨</span>
  </div>
  <label>æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰</label>
  <input id="qPcb" inputmode="numeric" placeholder="ä¾‹ï¼š0000"/>
  <label>é¸æŠ</label>
  <select id="selPcb"></select>
  <div class="tiny">â€» PCB_MASTER ã® status=æœªä½¿ç”¨ ã®ã¿</div>
</section>

<section class="card">
  <h2>ä¿å­˜</h2>
  <div class="row">
    <label style="flex:1">ä½œæ¥­åŒºåˆ†
      <select id="workType">
        <option value="çµ„ç«‹">çµ„ç«‹</option><option value="æ¤œæŸ»">æ¤œæŸ»</option>
        <option value="åŸºæ¿äº¤æ›">åŸºæ¿äº¤æ›</option><option value="ä¿®ç†">ä¿®ç†</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
    </label>
    <label style="flex:1">ä½œæ¥­è€…
      <input id="operator" placeholder="ä¾‹ï¼šå±±ç”°" autocomplete="name"/>
    </label>
  </div>
  <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
  <input id="note" placeholder="ä¾‹ï¼šå¤–è¦³OK"/>
  <div class="row" style="margin-top:12px">
    <button id="btnSave" class="primary" disabled>âœ… ä¿å­˜ï¼ˆç´ã¥ã‘å®Œäº†ï¼‰</button>
    <button id="btnReload">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
    <a class="tiny" href="?page=admin">ç®¡ç†è€…ç”»é¢</a>
  </div>
  <div id="status" class="status">æº–å‚™ä¸­â€¦</div>
</section>
<p class="tiny">Â© AIRSERVE.Co.,Ltd.</p>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function setStatus(msg, kind=null){
  const el = $("status");
  el.textContent = msg;
  el.className = "status" + (kind==="ok" ? " ok" : kind==="bad" ? " bad" : "");
}
function apiUrl(params){
  const u = new URL(window.location.href);
  u.searchParams.set("api","1");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}
async function loadBodies(q=""){
  const res = await fetch(apiUrl({action:"list_body", status:"åœ¨åº«", q, limit:"600"}));
  const j = await res.json();
  if(!j.ok) throw new Error(j.error||"list_body failed");
  const sel = $("selBody"); sel.innerHTML = "";
  j.rows.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.body_sn;
    opt.textContent = r.body_sn + (r.model ? ` (${r.model})` : "");
    sel.appendChild(opt);
  });
}
async function loadPcbs(q=""){
  const res = await fetch(apiUrl({action:"list_pcb", status:"æœªä½¿ç”¨", q, limit:"800"}));
  const j = await res.json();
  if(!j.ok) throw new Error(j.error||"list_pcb failed");
  const sel = $("selPcb"); sel.innerHTML = "";
  j.rows.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.pcb_sn;
    opt.textContent = r.pcb_sn + (r.received_date ? `ï¼ˆ${r.received_date}ï¼‰` : "");
    sel.appendChild(opt);
  });
}
function updateSaveEnabled(){ $("btnSave").disabled = !($("selBody").value && $("selPcb").value); }
async function saveLink(){
  const payload = {
    body_sn: $("selBody").value,
    pcb_sn: $("selPcb").value,
    work_type: $("workType").value,
    operator: $("operator").value.trim(),
    note: $("note").value.trim(),
  };
  setStatus("ä¿å­˜ä¸­â€¦");
  const res = await fetch(window.location.href, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"link", payload }),
  });
  const j = await res.json();
  if(!j.ok){ setStatus("ä¿å­˜å¤±æ•—ï¼š" + (j.error||""), "bad"); return; }
  setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼ˆæœ¬ä½“=ä½¿ç”¨ä¸­ / åŸºæ¿=ä½¿ç”¨ä¸­ ã«æ›´æ–°æ¸ˆã¿ï¼‰", "ok");
  await Promise.all([
    loadBodies($("qBody").value.trim()),
    loadPcbs($("qPcb").value.trim()),
  ]);
  updateSaveEnabled();
}
let t1=null, t2=null;
function wire(){
  $("btnSave").addEventListener("click", saveLink);
  $("btnReload").addEventListener("click", async()=>{ setStatus("å†èª­ã¿è¾¼ã¿ä¸­â€¦"); await init(); });
  $("selBody").addEventListener("change", updateSaveEnabled);
  $("selPcb").addEventListener("change", updateSaveEnabled);
  $("qBody").addEventListener("input", ()=>{
    clearTimeout(t1);
    t1=setTimeout(()=>loadBodies($("qBody").value.trim()).then(updateSaveEnabled).catch(e=>setStatus("æœ¬ä½“SNèª­è¾¼ã‚¨ãƒ©ãƒ¼ï¼š"+e.message,"bad")), 250);
  });
  $("qPcb").addEventListener("input", ()=>{
    clearTimeout(t2);
    t2=setTimeout(()=>loadPcbs($("qPcb").value.trim()).then(updateSaveEnabled).catch(e=>setStatus("åŸºæ¿SNèª­è¾¼ã‚¨ãƒ©ãƒ¼ï¼š"+e.message,"bad")), 250);
  });
}
async function init(){
  try{
    await Promise.all([loadBodies(""), loadPcbs("")]);
    updateSaveEnabled();
    setStatus("æº–å‚™OKã€‚é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
  }catch(e){
    setStatus("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼š"+e.message+"ï¼ˆç®¡ç†è€…ç”»é¢ã§å–è¾¼/ç™»éŒ²ã—ã¦ãã ã•ã„ï¼‰","bad");
  }
}
wire(); init();
</script>
</body></html>
