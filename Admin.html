<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title><?= appTitle ?>ï¼ˆç®¡ç†è€…ï¼‰</title>
<style>
:root{--card:#121a26;--muted:#93a4b8;--text:#eaf2ff;--border:#223047;--ok:#7CFF8B;--bad:#ff6b6b;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP","Yu Gothic";background:linear-gradient(180deg,#0b0f16,#0a1220);color:var(--text)}
header{position:sticky;top:0;background:rgba(11,15,22,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:14px 12px}
h1{margin:0;font-size:18px}.sub{margin:4px 0 0;color:var(--muted);font-size:12px}
main{max-width:1080px;margin:0 auto;padding:12px}
.card{background:rgba(18,26,38,.92);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0}
h2{margin:0 0 10px;font-size:15px}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);font-size:15px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{border:1px solid var(--border);background:#0f1622;color:var(--text);padding:10px 12px;border-radius:14px;font-size:14px;cursor:pointer}
button.primary{background:linear-gradient(180deg,#1a3048,#102338);border-color:#2a4568}
button.warn{background:linear-gradient(180deg,#3b2a1a,#2a1d12);border-color:#6a4b2a}
button:disabled{opacity:.45;cursor:not-allowed}
.status{margin-top:10px;font-size:13px;color:var(--muted)}.status.ok{color:var(--ok)}.status.bad{color:var(--bad)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:13px}
.tiny{font-size:11px;color:var(--muted)}a{color:#4dd4ff;text-decoration:none}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
</style>
</head><body>
<header>
  <h1>ç®¡ç†è€…ç”»é¢</h1>
  <p class="sub">ä¿®ç†æˆ»ã‚Šã€Œåœ¨åº«ã¸æˆ»ã™ã€ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ï¼ˆEVENT_LOGï¼‰</p>
</header>
<main>

<section class="card">
  <div class="row" style="justify-content:space-between">
    <h2>0) ç”»é¢ãƒªãƒ³ã‚¯</h2>
    <a href="./">â† ç¾å ´ç”»é¢ã¸</a>
  </div>
  <div class="tiny">â€» Excelå–è¾¼ï¼ˆåŸºæ¿/æœ¬ä½“ï¼‰ã¯ v2 ã¨åŒæ§˜ã« Admin ã«è¿½åŠ ã§ãã¾ã™ã€‚ã¾ãšã¯ä¿®ç†æˆ»ã‚Šé‹ç”¨ã‚’æœ€å„ªå…ˆã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚</div>
</section>

<section class="card">
  <div class="row" style="justify-content:space-between">
    <h2>1) ä¿®ç†æˆ»ã‚Šï¼šåœ¨åº«ã¸æˆ»ã™ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰</h2>
    <span class="pill">æœ¬ä½“SNã®ã¿</span>
  </div>

  <div class="row">
    <label style="flex:1">ä½œæ¥­è€…ï¼ˆä»»æ„ï¼‰<input id="rtOperator" placeholder="ä¾‹ï¼šå±±ç”°"></label>
    <label style="flex:2">å‚™è€ƒï¼ˆä»»æ„ï¼‰<input id="rtNote" placeholder="ä¾‹ï¼šåŸºæ¿äº¤æ›æ¸ˆã¿ã€‚æœ€çµ‚æ¤œæŸ»OK"></label>
  </div>

  <div class="row">
    <label style="flex:1">æœ¬ä½“SNï¼ˆ8æ¡ï¼‰<input id="rtSn" inputmode="numeric" placeholder="00000001"></label>
    <button id="btnReturn" class="warn">â†© åœ¨åº«ã¸æˆ»ã™</button>
    <span class="tiny">æŠ¼ã™ã¨ status=åœ¨åº« ã«æ›´æ–°ã—ã€EVENT_LOGã«å±¥æ­´ã‚’æ®‹ã—ã¾ã™</span>
  </div>
  <div id="rtMsg" class="status"></div>

  <hr style="border:0;border-top:1px solid var(--border);margin:14px 0">

  <div class="row">
    <label style="flex:1">æœ¬ä½“SNæ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰<input id="rtSearch" inputmode="numeric" placeholder="ä¾‹ï¼š1234"></label>
    <button id="btnRtLoad" class="primary">ğŸ” ä¸€è¦§è¡¨ç¤º</button>
  </div>
  <div class="tiny">ä½¿ç”¨ä¸­/ä¿®ç†ä¸­ã®ã‚‚ã®ã‚’æ¢ã—ã¦ã€ãã®å ´ã§ã€Œåœ¨åº«ã¸æˆ»ã™ã€ã§ãã¾ã™ã€‚</div>

  <div style="overflow:auto">
    <table id="rtTbl">
      <thead><tr><th>æœ¬ä½“SN</th><th>ãƒ¢ãƒ‡ãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>2) å±¥æ­´ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼šEVENT_LOGï¼‰</h2>
  <div class="row">
    <label style="flex:1">Fromï¼ˆyyyy-mm-ddï¼‰<input id="evFrom" placeholder="2025-12-01"/></label>
    <label style="flex:1">Toï¼ˆyyyy-mm-ddï¼‰<input id="evTo" placeholder="2025-12-31"/></label>
    <label style="flex:1">SNæ¤œç´¢ï¼ˆä»»æ„ï¼‰<input id="evQ" inputmode="numeric" placeholder="ä¾‹ï¼š0000"/></label>
    <button id="btnEvLoad" class="primary">ğŸ” è¡¨ç¤º</button>
    <button id="btnEvCsv">â¬‡ CSV</button>
  </div>
  <div id="evMsg" class="status"></div>
  <div style="overflow:auto">
    <table id="evTbl"><thead><tr><th>æ—¥æ™‚</th><th>ç¨®åˆ¥</th><th>SN</th><th>From</th><th>To</th><th>ä½œæ¥­è€…</th><th>å‚™è€ƒ</th></tr></thead><tbody></tbody></table>
  </div>
</section>

<p class="tiny">Â© AIRSERVE.Co.,Ltd.</p>
</main>

<script>
const $=(id)=>document.getElementById(id);
function setMsg(id,msg,kind=null){
  const el=$(id);
  el.textContent=msg;
  el.className="status"+(kind==="ok"?" ok":kind==="bad"?" bad":"");
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeSn8(sn){
  let s=(sn??"").toString().trim();
  s=s.replace(/[ï¼-ï¼™]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
  s=s.replace(/[^0-9]/g,"");
  if(!s) return "";
  if(s.length>8) s=s.slice(-8);
  return s.padStart(8,"0");
}
async function post(action, payload){
  const res=await fetch(window.location.href,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(Object.assign({action}, payload||{}))
  });
  return await res.json();
}
function apiUrl(params){
  const u=new URL(window.location.href);
  u.searchParams.set("api","1");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}

/* ===== Return to stock ===== */
async function returnToStock(sn){
  const operator=$("rtOperator").value.trim();
  const note=$("rtNote").value.trim() || "ä¿®ç†æˆ»ã‚Šï¼šåœ¨åº«ã¸æˆ»ã™";
  return await post("update_status",{kind:"body", sn, status:"åœ¨åº«", operator, note});
}
$("btnReturn").addEventListener("click", async()=>{
  const sn=normalizeSn8($("rtSn").value);
  if(!sn){ setMsg("rtMsg","SNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","bad"); return; }
  setMsg("rtMsg","æ›´æ–°ä¸­â€¦");
  const j=await returnToStock(sn);
  if(!j.ok){ setMsg("rtMsg","å¤±æ•—ï¼š"+(j.error||""),"bad"); return; }
  setMsg("rtMsg",`æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${sn}ï¼š${j.from_status} â†’ ${j.to_status}ï¼‰`,"ok");
  await loadReturnList();
});

async function loadReturnList(){
  const q=$("rtSearch").value.trim();
  const res=await fetch(apiUrl({action:"list_body", status:"", q, limit:"500"}));
  const j=await res.json();
  const tbody=$("rtTbl").querySelector("tbody"); tbody.innerHTML="";
  if(!j.ok){ setMsg("rtMsg","ä¸€è¦§å–å¾—å¤±æ•—ï¼š"+(j.error||""),"bad"); return; }
  j.rows.forEach(r=>{
    const disabled = (r.status==="åœ¨åº«");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(r.body_sn)}</td><td>${escapeHtml(r.model||"")}</td><td>${escapeHtml(r.status||"")}</td>
      <td><button class="warn" data-sn="${r.body_sn}" ${disabled?"disabled":""}>â†© åœ¨åº«ã¸æˆ»ã™</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-sn]").forEach(b=>{
    b.addEventListener("click", async()=>{
      const sn=b.getAttribute("data-sn");
      setMsg("rtMsg",`æ›´æ–°ä¸­â€¦ï¼ˆ${sn}ï¼‰`);
      const j2=await returnToStock(sn);
      if(!j2.ok){ setMsg("rtMsg","å¤±æ•—ï¼š"+(j2.error||""),"bad"); return; }
      setMsg("rtMsg",`æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${sn}ï¼š${j2.from_status} â†’ ${j2.to_status}ï¼‰`,"ok");
      await loadReturnList();
    });
  });
}
$("btnRtLoad").addEventListener("click", loadReturnList);

/* ===== Event log ===== */
$("btnEvLoad").addEventListener("click", async()=>{
  const from=$("evFrom").value.trim();
  const to=$("evTo").value.trim();
  const q=$("evQ").value.trim();
  setMsg("evMsg","èª­ã¿è¾¼ã¿ä¸­â€¦");
  const res=await fetch(apiUrl({action:"list_event", from, to, q, limit:"2000"}));
  const j=await res.json();
  if(!j.ok){ setMsg("evMsg","å¤±æ•—ï¼š"+(j.error||""),"bad"); return; }
  const tbody=$("evTbl").querySelector("tbody"); tbody.innerHTML="";
  j.rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(r.timestamp_jst)}</td><td>${escapeHtml(r.kind)}</td><td>${escapeHtml(r.sn)}</td><td>${escapeHtml(r.from_status)}</td><td>${escapeHtml(r.to_status)}</td><td>${escapeHtml(r.operator)}</td><td>${escapeHtml(r.note)}</td>`;
    tbody.appendChild(tr);
  });
  setMsg("evMsg",`è¡¨ç¤ºä»¶æ•°ï¼š${j.rows.length}`,"ok");
});
$("btnEvCsv").addEventListener("click", ()=>{
  const from=$("evFrom").value.trim();
  const to=$("evTo").value.trim();
  const q=$("evQ").value.trim();
  const u=new URL(window.location.href);
  u.searchParams.set("api","1"); u.searchParams.set("action","export_event_csv");
  if(from) u.searchParams.set("from",from);
  if(to) u.searchParams.set("to",to);
  if(q) u.searchParams.set("q",q);
  window.open(u.toString(), "_blank");
});

loadReturnList();
</script>
</body></html>
